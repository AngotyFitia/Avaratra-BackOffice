@page
@model Avaratra.BackOffice.Pages_Districts.IndexModel

@{
    ViewData["Title"] = "Districts";
}
@section Styles {
     <link rel="stylesheet" href="~/assets/css/personal_style/Index.css" />
    <link rel="stylesheet" href="~/assets/css/ol.css" />
    <style>
      #tooltip {
        z-index: 1000;
        background: rgba(0,0,0,0.75);
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        display: none;
      }
    </style>

}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="mb-1">Districts</h3>
        <small class="text-muted">Gestion et recherche des districts</small>
    </div>
    <div class="d-flex gap-2">
    <form method="post" asp-page="Index" enctype="multipart/form-data" asp-page-handler="ImportCsv" >
        <input type="file" id="csvFileInput" name="csvFile" style="display:none" />
        <button type="submit" class="btn btn-inverse-success btn-fw" id="btnImportCsv"><i class="mdi mdi-file-import"></i> Import csv</button>
        <a asp-page="Create" class="btn btn-inverse-primary btn-fw" data-bs-toggle="modal" data-bs-target="#createModal"><i class="icon-plus"></i> Nouveau district</a>
        @if (TempData["Succes"] != null || TempData["Erreur"] != null)
        {
          <div class="toast-container">
            <div id="liveToast" class="toast-custom @(TempData["Succes"] != null ? "toast-success" : "toast-error")" role="alert">
                <div class="toast-body">
                    @Html.Raw(TempData["Succes"] ?? TempData["Erreur"])
                </div>
                <button type="button" class="toast-close" onclick="hideToast()">×</button>
            </div>
          </div>  
        }
    </form>
    </div>
</div>

<form method="get" class="mb-4">
  <div class="row g-2 align-items-center">
    <div class="col-md-2">
      <input type="text" class="form-control form-control-sm" placeholder="District" name="SearchIntitule" >
    </div>
    <div class="col-md-2">
      <input type="text" class="form-control form-control-sm" placeholder="Région" name="SearchRegion" >
    </div>
    <div class="col-md-2">
      <input type="number" class="form-control form-control-sm" placeholder="Min pop." name="MinPopulation">
    </div>
    <div class="col-md-2">
      <input type="number" class="form-control form-control-sm" placeholder="Max pop." name="MaxPopulation">
    </div>
    <div class="col-md-2">
      <select class="form-select form-select-sm" name="Etat">
        <option value="">État</option>
        <option value="0" selected="@(Model.Etat == 0)">Non validé</option>
        <option value="5" selected="@(Model.Etat == 5)">Validé</option>
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-inverse-secondary">
        <i class="icon-search"></i>
      </button>
      <button type="button" class="btn btn-inverse-secondary" style="margin-left:10px" onclick="window.location.href='/Districts'">
        <i class="mdi mdi-refresh"></i>
      </button>
    </div>
  </div>
</form>

<hr />
@if (Model.Districts != null && Model.Districts.Any()){
  <div class="d-flex justify-content-end mb-2 gap-2">
      <button type="button" class="btn btn-inverse-danger btn-fw" id="deleteAllBtn" >Tout supprimer</button>
      <button type="button" class="btn btn-inverse-success btn-fw" id="validateAllBtn" >Valider tout</button>
      <a asp-page-handler="ExportAllPdf" asp-route-SearchIntitule="@Model.SearchIntitule" asp-route-SearchRegion="@Model.SearchRegion" asp-route-MinPopulation="@Model.MinPopulation" asp-route-MaxPopulation="@Model.MaxPopulation" class="btn btn-inverse-secondary btn-fw">Exporter PDF</a>

  </div>

  <table class="table table-hover align-middle" >
      <thead class="table-light">
          <tr>
              <th scope="col" class="text-center"> <input type="checkbox" id="selectAll"></th>
              <th class="text-start">District</th>
              <th class="text-center">Région</th>
              <th class="text-center">Total population</th>
              <th class="text-center">Etat</th>
              <th class="text-center">Actions</th>
          </tr>
      </thead>
      <tbody>
          @foreach (var item in Model.Districts)
          {
            <tr>
                <td class="text-center"><input type="checkbox" class="rowCheckbox" data-id="@item.idDistrict"/></td>
                <td class="text-start"style="word-wrap: break-word; width: 250px;  white-space: normal;" >@item.intitule</td>
                <td class="text-center">@item.Region.intitule </td>
                <td class="text-center">@item.totalPopulationDistrict</td>
                <td class="text-center"><span class="@item.EtatCssClass">@item.EtatText</span></td>
                <td class="text-center">
                <button type="button" style="@item.DisplayCrudButtons" class="btn btn-inverse-warning btn-xs custom-width" data-bs-toggle="modal" data-bs-target="#editModal" data-id="@item.idDistrict" data-name="@item.intitule" data-pop="@item.totalPopulationDistrict"><i class="mdi mdi-pen"></i></button>
                <button type="button" style="@item.DisplayCrudButtons" class="btn btn-inverse-danger btn-xs custom-width" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="@item.idDistrict" data-name="@item.intitule"><i class="mdi mdi-delete"></i></button>
                <button type="button" style="@item.DisplayCrudButtons" class="btn btn-inverse-success btn-xs custom-width" data-bs-toggle="modal" data-bs-target="#validateModal" data-id="@item.idDistrict" data-name="@item.intitule"> <i class="mdi mdi-check"></i></button>
                <button type="button" style="@item.DisplaySpecialValidation" class="btn btn-success btn-xs custom-width" data-bs-toggle="modal" data-bs-target="#finalModal" data-id="@item.idDistrict" data-name="@item.intitule"> <i class="mdi mdi-check"></i></button>
                <button type="button" style="@item.DisplayFinalValidation" class="btn btn-inverse-primary btn-xs custom-width" data-bs-toggle="modal" data-bs-target="#viewModal" data-id="@item.idDistrict" data-name="@item.intitule" data-pop="@item.totalPopulationDistrict" data-geometry="@item.geometrie.ToText()"><i class="mdi mdi-eye"></i></button>
                <a asp-page-handler="ExportPdf" asp-route-id="@item.idDistrict" style="@item.DisplayFinalValidation" class="btn btn-inverse-secondary btn-xs custom-width"><i class="mdi mdi-file-pdf-box"></i></a></td>
            </tr>
          }
      </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <form method="get" class="d-flex align-items-center">
      <div class="d-flex align-items-center"> 
      <label for="pageSize" class="me-2">Afficher :</label> 
      <select class="form-select d-inline-block w-auto"  id="pageSize"  name="PageSize" onchange="this.form.submit()">> 
          <option value="1" selected="@(Model.PageSize == 1)">5</option>
          <option value="15" selected="@(Model.PageSize == 15)">15</option>
          <option value="101" selected="@(Model.PageSize == 101)">20</option>
      </select> 
      <span class="ms-2">par page</span>
        <input type="number" id="customPageSize" name="PageSize" style="display:none;" min="1" max="100">
      </div> 
      <input type="hidden" name="pageIndex" value="1" />
      <input type="hidden" name="SearchIntitule" value="@(Model.SearchIntitule)" />
      <input type="hidden" name="SearchRegion" value="@(Model.SearchRegion)" />
      <input type="hidden" name="MinPopulation" value="@(Model.MinPopulation)" />
      <input type="hidden" name="MaxPopulation" value="@(Model.MaxPopulation)" />
      <input type="hidden" name="Etat" value="@(Model.Etat)" />
    </form>
    <nav aria-label="Page navigation example" class="mt-3">
        <ul class="pagination justify-content-end">
        <li class="page-item disabled">
                <span class="page-link">
                    Page @Model.Districts.PageIndex / @Model.Districts.TotalPages
                </span>
            </li>
            @if (Model.Districts.HasPreviousPage)
            {
              <li class="page-item"><a class="page-link" asp-route-pageIndex="@(Model.Districts.PageIndex - 1)">Précédent</a></li>
            }
            @if (Model.Districts.HasNextPage)
            {
              <li class="page-item"><a class="page-link" asp-route-pageIndex="@(Model.Districts.PageIndex + 1)">Suivant</a></li>
            }
        </ul>
    </nav>
  </div>

}else { 
  <p class="text-center text-muted fw-bold mt-3">
  <i class="mdi mdi-alert-circle-outline"></i> Aucun district trouvé</p>
}

<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
    <form method="post" asp-page-handler="Create">
      <div class="modal-header">
        <h5 class="modal-title" id="createModalLabel">Créer un nouveau district</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
            <input type="text" class="form-control form-control-sm" id="regionName" placeholder="District" asp-for="District.intitule">
        </div>
        <div class="form-group">
            <label for="exampleSelectGender">Region</label> 
            <select class="form-select" id="exampleSelectGender" asp-for="District.IdRegion">
                @foreach (var item in Model.RegionsValidees)
                {
                    <option value="@item.idRegion">@item.intitule</option>
                }
            </select>
        </div>
        <div class="mb-2">
            <input type="number"  class="form-control form-control-sm" step="any"  placeholder="Nombre de population" asp-for="District.totalPopulationDistrict">
        </div>
      </div>
      <div class="modal-footer p-2">
        <button type="button" class="btn btn-secondary btn" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary btn" id="saveRegionBtn">Enregistrer</button>
      </div>
      @if (!ViewData.ModelState.IsValid)
      {
          <div class="alert alert-danger d-flex flex-column align-items-center mx-auto text-center" role="alert" style="border-radius:8px; font-weight:500;  max-width:450px;">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <div>
                  @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                  {
                    <div >@error.ErrorMessage</div>
                  }
              </div>
          </div>
      }
    </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" >
    <form method="post" asp-page="Index" asp-page-handler="Update">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Modifier le district</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="districtId" asp-for="District.idDistrict"/>
            <div class="mb-2">
                <label for="exampleSelectGender">District</label> 
                <input type="text" class="form-control form-control-sm" id="districtName" asp-for="District.intitule" placeholder="Nom">
            </div>
            <div class="form-group">
                <label for="exampleSelectGender">Region</label> 
                <select class="form-select" id="regionList" asp-for="District.IdRegion">
                    @foreach (var item in Model.RegionsValidees)
                    {
                        if (Model.District != null && item.idRegion == Model.District.IdRegion)
                        {
                          <option value="@item.idRegion" selected>@item.intitule</option>
                        }
                        else
                        {
                          <option value="@item.idRegion">@item.intitule</option>
                        }
                    }

                </select>
            </div>
            <div class="mb-2">
                <label for="exampleSelectGender">Nombre de population</label> 
                <input type="number" class="form-control form-control-sm" id="districtPop" asp-for="District.totalPopulationDistrict" step="any" placeholder="Nombre de population">
            </div>
        </div>
        <div class="modal-footer p-2">
            <button type="button" class="btn btn-secondary btn" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary btn" id="saveRegionBtn">Enregistrer</button>
        </div>
        </div>
    </form>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">   
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <form method="post" asp-page="Index" asp-page-handler="Delete">  
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="districtId" name="id"/>
        <p>Voulez-vous vraiment supprimer le district "<strong id="districtName"></strong>" de la liste?</p>
      </div>
      <div class="modal-footer p-2">
        <button type="button" class="btn btn-inverse-danger btn-fw" data-bs-dismiss="modal">Non</button>
        <button type="submit" class="btn btn-inverse-success btn-fw" id="confirmDeleteBtn">Oui</button>
      </div>
    </div>
    </form>
  </div>
</div>

<div class="modal fade" id="validateModal" tabindex="-1" aria-labelledby="validateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
  <form method="post" asp-page="Index"  asp-page-handler="Validate">  
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="validateModalLabel">Confirmer la validation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="districtId" name="id" value="districtId"/>
        <p>Voulez-vous vraiment valider le district "<strong id="districtName"></strong>" ?</p>
      </div>
      <div class="modal-footer p-2">
        <button type="button" class="btn btn-inverse-danger btn-fw" data-bs-dismiss="modal">Non</button>
        <button type="submit" class="btn btn-inverse-success btn-fw" id="confirmDeleteBtn">Oui</button>
      </div>
    </div>
    </form>
  </div>
</div>

<div class="modal fade" id="finalModal" tabindex="-1" aria-labelledby="finalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
  <form method="post" asp-page-handler="Confirm">  
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="finalModalLabel">Confirmation du district</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="districtId" name="id" />
        <p>Voulez-vous vraiment valider le district "<strong id="districtName"></strong>" ?</p>
        <p>La validation de ce ditrict va aussi alors valider toutes les communes et il sera possible de voir le district sur la carte.</p>
      </div>
      <div class="modal-footer p-2">
        <button type="button" class="btn btn-inverse-danger btn-fw" data-bs-dismiss="modal">Non</button>
        <button type="submit" class="btn btn-inverse-success btn-fw" id="confirmDeleteBtn">Oui</button>
      </div>
    </div>
    </form>
  </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Géométrie du district</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="map" style="height:400px; width:100%; position:relative;">
        <div id="tooltip"></div>
      </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script src="~/assets/js/personal/district.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/assets/js/ol.js"></script>
    <script>console.log("OpenLayers version:", ol.VERSION);</script>
    <script>
          document.addEventListener("DOMContentLoaded", function () {
        const toastEl = document.getElementById("liveToast");
        if (toastEl) {
            toastEl.classList.add("show");
            setTimeout(() => toastEl.classList.remove("show"), 3000);
        }
    });
    </script>
    <script>
      $(document).ready(function () {
          var showModal = '@ViewData["ShowCreateModal"]';
          if (showModal === 'True') {
              var myModal = new bootstrap.Modal(document.getElementById('createModal'));
              myModal.show();
          }
      });
    </script>
}